{{ if .Values.headlamp.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: openunison-headlamp-plugin
  namespace: {{ .Release.Namespace }}
data:
  main.js: |
    (function(a,i){typeof exports=="object"&&typeof module<"u"?i(require("react/jsx-runtime"),require("@kinvolk/headlamp-plugin/lib"),require("@kinvolk/headlamp-plugin/lib/k8s"),require("react"),require("@mui/material")):typeof define=="function"&&define.amd?define(["react/jsx-runtime","@kinvolk/headlamp-plugin/lib","@kinvolk/headlamp-plugin/lib/k8s","react","@mui/material"],i):(a=typeof globalThis<"u"?globalThis:a||self,i(a.pluginLib.ReactJSX,a.pluginLib,a.pluginLib.K8s,a.pluginLib.React,a.pluginLib.MuiMaterial))})(this,(function(a,i,A,k,c){"use strict";const o=(e=>e&&typeof e=="object"&&"default"in e?e:{default:e})(k),w="openunison-headlamp-plugin.settings";function S(){try{const e=localStorage.getItem(w);if(!e)return{enabled:!0,preferDefaultNamespace:!0,namespacesUrl:"/apis/namespaces",meUrl:"/apis/me"};const r=JSON.parse(e);return{enabled:r.enabled??!0,namespacesUrl:r.namespacesUrl??"/apis/namespaces",meUrl:r.meUrl??"/apis/me",preferDefaultNamespace:r.preferDefaultNamespace??!0}}catch{return{enabled:!0,preferDefaultNamespace:!0,namespacesUrl:"/apis/namespaces",meUrl:"/apis/me"}}}function v(e){localStorage.setItem(w,JSON.stringify(e))}function I(e,r){if(e.length!==r.length)return!1;const n=new Map;for(const t of e)n.set(t,(n.get(t)??0)+1);for(const t of r){const s=n.get(t);if(!s)return!1;s===1?n.delete(t):n.set(t,s-1)}return n.size===0}function E(e,r,n){const t=localStorage.getItem(`cluster_settings.${e}`),s=JSON.parse(t);if(n||(n="default"),s!=null&&s.defaultNamespace||(s.defaultNamespace="default"),s!=null&&s.allowedNamespaces||(s.allowedNamespaces=[]),n!=s.defaultNamespace||!I(s.allowedNamespaces,r)){n&&(s.defaultNamespace=n),r&&(s.allowedNamespaces=r);const p=JSON.stringify(s);localStorage.setItem(`cluster_settings.${e}`,p),window.location.reload()}}async function T(e,r,n){e&&E(e,r,n)}async function C(e){(!e||e=="")&&(e="/api/namespaces");const r=await fetch(e,{credentials:"include"});if(!r.ok)throw new Error(`Namespaces URL failed: ${r.status}`);const n=await r.json(),t=Array.isArray(n)?n:n.namespaces;if(!Array.isArray(t))throw new Error("Namespaces payload is not an array");return t.map(s=>String(s)).filter(Boolean)}function D(){const e=A.useCluster(),[r,n]=o.default.useState("");return o.default.useEffect(()=>{var h;if(!e)return;const t=S();if(!t.enabled||!((h=t.namespacesUrl)!=null&&h.trim()))return;const s=`${e}|${t.namespacesUrl}|${t.preferDefaultNamespace}`;if(s===r)return;let p=!1;return(async()=>{const l=await C(t.namespacesUrl);if(p)return;const m=t.preferDefaultNamespace&&l.includes("default")?"default":l[0];await T(e,l,m),p||(console.info("[vt-limit-namespaces] Applied limits",{clusterName:e,namespaces:l,defaultNamespace:m}),n(s))})().catch(l=>console.error("[vt-limit-namespaces] Failed",l)),()=>{p=!0}},[e,r]),null}function $(){const[e,r]=o.default.useState(()=>S()),n=t=>{const s={...e,...t};r(s),v(s)};return a.jsxs(c.Box,{sx:{p:2},children:[a.jsx(c.Typography,{variant:"h6",sx:{mb:2},children:"OpenUnison Integration"}),a.jsx(c.FormControlLabel,{control:a.jsx(c.Switch,{checked:!!e.enabled,onChange:t=>n({enabled:t.target.checked})}),label:"Enable"}),a.jsx(c.TextField,{label:"Namespaces URL",value:e.namespacesUrl??"/api/namespaces",onChange:t=>n({namespacesUrl:t.target.value}),fullWidth:!0,sx:{mt:2},placeholder:"/apis/namespaces",helperText:'Supports: ["ns1","ns2"] or {"namespaces":["ns1","ns2"]}'}),a.jsx(c.TextField,{label:"Me URL",value:e.meUrl??"/apis/me",onChange:t=>n({meUrl:t.target.value}),fullWidth:!0,sx:{mt:2},placeholder:"/apis/me",helperText:'Supports: {"userInfo":{"username":"myusername","groups":["system:authenticated","group1","group2","users"]}}'}),a.jsx(c.FormControlLabel,{sx:{mt:2},control:a.jsx(c.Switch,{checked:!!e.preferDefaultNamespace,onChange:t=>n({preferDefaultNamespace:t.target.checked})}),label:'Prefer "default" as defaultNamespace when present'})]})}function _({}){const{SectionBox:e,Table:r}=i.CommonComponents,[n,t]=o.default.useState(!0),[s,p]=o.default.useState(null),[h,l]=o.default.useState(""),[m,N]=o.default.useState([]);o.default.useEffect(()=>{let g=!1;return(async()=>{var L,x;try{t(!0),p(null);const f=S();if(!f.enabled)return;var u=f.meUrl;console.log("URL : "+u),(!u||u=="")&&(u="/apis/me"),console.log("URL : "+u);const y=await fetch(u,{method:"GET",credentials:"include",headers:{Accept:"application/json"}});if(!y.ok){console.warn(`Error loading me ${u} ${y.status} ${y.statusText}`),l("UNKNOWN"),N([]);return}const d=await y.json(),j=((L=d==null?void 0:d.userInfo)==null?void 0:L.username)??"",M=Array.isArray((x=d==null?void 0:d.userInfo)==null?void 0:x.groups)?d.userInfo.groups:[];g||(l(j),N(M))}catch(f){g||(p((f==null?void 0:f.message)??String(f)),l(""),N([]))}finally{g||t(!1)}})(),()=>{g=!0}},[]);const K=o.default.useMemo(()=>[{header:"Group",accessorKey:"group"}],[]),P=o.default.useMemo(()=>m.map(g=>({group:g})),[m]);return a.jsx("div",{children:a.jsx(e,{title:"Who Am I?",children:n?a.jsx("div",{children:"Loading…"}):s?a.jsxs("div",{style:{whiteSpace:"pre-wrap"},children:[a.jsx("strong",{children:"Error:"})," ",s]}):a.jsxs(a.Fragment,{children:[a.jsx("p",{style:{marginTop:0},children:"This information reflects the identity Kubernetes sees for your current session. It includes your authenticated username and the groups associated with that identity.  It is the same information provided by kubectl auth whoami."}),a.jsxs("div",{style:{marginBottom:12},children:[a.jsx("strong",{children:"Username:"})," ",h||"—"]}),a.jsx(r,{title:`Groups (${m.length})`,columns:K,data:P})]})})})}const U="whoami",b="/whoami";i.registerSidebarEntry({parent:"cluster",name:U,label:"Who Am I?",url:b}),i.registerPluginSettings("openunison-headlamp-plugin",$),i.registerRoute({path:b,sidebar:U,component:()=>a.jsx(_,{})}),i.registerAppBarAction(a.jsx(D,{}))}));
  package.json: |-
    {
      "name": "openunison-headlamp-plugin",
      "version": "0.2.0",
      "description": "Your Headlamp plugin",
      "scripts": {
        "start": "headlamp-plugin start",
        "build": "headlamp-plugin build",
        "format": "headlamp-plugin format",
        "lint": "headlamp-plugin lint",
        "lint-fix": "headlamp-plugin lint --fix",
        "package": "headlamp-plugin package",
        "tsc": "headlamp-plugin tsc",
        "storybook": "headlamp-plugin storybook",
        "storybook-build": "headlamp-plugin storybook-build",
        "test": "headlamp-plugin test",
        "i18n": "headlamp-plugin i18n"
      },
      "keywords": [
        "headlamp",
        "headlamp-plugin",
        "kubernetes",
        "kubernetes-ui",
        "kubernetes-debugging",
        "plugins"
      ],
      "prettier": "@headlamp-k8s/eslint-config/prettier-config",
      "eslintConfig": {
        "extends": [
          "@headlamp-k8s",
          "prettier",
          "plugin:jsx-a11y/recommended"
        ]
      },
      "overrides": {
        "typescript": "5.6.2"
      },
      "devDependencies": {
        "@kinvolk/headlamp-plugin": "^0.13.0"
      }
    }
{{ end }}